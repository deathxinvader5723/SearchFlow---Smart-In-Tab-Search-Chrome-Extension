const l="SelectToSearchDB";const a="settings",c={enabled:!0,providers:{chatgpt:!0,google:!0,gemini:!0},affordanceMode:"quick-actions",theme:"light"};function d(){return new Promise((n,t)=>{const e=indexedDB.open(l,1);e.onerror=()=>t(e.error),e.onsuccess=()=>n(e.result),e.onupgradeneeded=r=>{const o=r.target.result;o.objectStoreNames.contains(a)||o.createObjectStore(a)}})}async function u(){try{const n=await d();return new Promise((t,e)=>{const s=n.transaction(a,"readonly").objectStore(a).get("userSettings");s.onerror=()=>e(s.error),s.onsuccess=()=>{const i=s.result;t(i?{...c,...i,providers:{...c.providers,...(i.providers||{})}}:c)}})}catch(n){return console.error("Failed to get settings from DB:",n),c}}class h{constructor(){this.init()}init(){chrome.runtime.onMessage.addListener(this.handleMessage.bind(this)),chrome.runtime.onInstalled.addListener(this.handleInstalled.bind(this)),console.log("SearchFlow background service worker initialized")}handleMessage(t,e,r){return t.type==="OPEN_TAB"?(this.openProviderTab(t.url).then(()=>{r({success:!0})}).catch(o=>{console.error("Failed to open tab:",o),r({success:!1,error:o.message})}),!0):t.type==="GET_SETTINGS"?(u().then(o=>{r(o)}).catch(o=>{console.error("Failed to get settings:",o),r(null)}),!0):(t.type==="SETTINGS_UPDATED"&&this.broadcastSettings(t.settings),!1)}async broadcastSettings(t){try{const e=await chrome.tabs.query({});for(const r of e)if(r.id)try{await chrome.tabs.sendMessage(r.id,{type:"SETTINGS_UPDATED",settings:t})}catch{}}catch(e){console.error("Failed to broadcast settings:",e)}}async openProviderTab(t){try{const e=this.validateUrl(t);if(!e)throw new Error("Invalid URL provided");await chrome.tabs.create({url:e,active:!0})}catch(e){throw console.error("Error opening tab:",e),e}}validateUrl(t){try{const e=new URL(t);return e.protocol!=="https:"?(console.warn("Non-HTTPS URL blocked:",t),null):["www.google.com","chatgpt.com","gemini.google.com"].includes(e.hostname)?t:(console.warn("Untrusted domain blocked:",e.hostname),null)}catch(e){return console.error("URL validation error:",e),null}}handleInstalled(t){t.reason==="install"?console.log("SearchFlow extension installed"):t.reason==="update"&&console.log("Extension updated to version:",chrome.runtime.getManifest().version)}}new h;
